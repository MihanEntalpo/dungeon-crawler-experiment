# Архитектура проекта

## 1. Общая информация

* Проект представляет собой браузерную игру на html + css + js
* Проект пишется по возможности без зависимостей от сторонних библиотек, на базе возможностей VanillaJS
* Проект не использует TypeScript, компиляторов, js/css фреймворков
* Модульность проекта обеспечивается тем, что в файл index.html через тэги <script></script> в начале подгружаются все отдельные файлы проекта
* Для ООП используются обычные классы JavaScript
* Для сохранения состояния игры используется библиотека localForage

## 2. Функциональность игры

Игра состоит из нескольких базовых режимов:

### 2.1. Главное меню при запуске игры

В главном меню можно:

* Создать новую игру
* Просмотреть список сохранённых игр, их может быть не более трёх
* Загрузить одну из сохранённых игр

### 2.2. Собственно игра

#### 2.2.1. Общее описание

* Представляет собой Dungeon Crawler с видом сверху (без наклона камеры, чётко сверху)
* Карта состоит из тайлов
* Персонаж, NPC, враги перемещаются плавно, не скачками по ячейкам, а по пиксельно
* Персонаж, NPC, враги могут вращаться вокруг своей оси
* Тайлы, которые пользователь ещё ни разу не видел - скрыты черными тайлами сверху
* Видимость тайлов определяется направлением взгляда игрока
* Игрок управляется клавиатурой и мышью, клавиши AWSD (или ФЦЫВ в русской раскладке) позволяют ему перемещаться в 4-х направлениях, мышка указывает его направление поворота, и направление взгляда и атаки
* В игре единая большая карта, в ней отдельных "локаций" для перехода между которыми происходила бы подгрузка, весь мир - это единая карта. 
    * Технически, удалённые локации могут быть выгружены из памяти пока они слишкмо далеко, и подгружаться по мере необходимости, но для пользователя это должно быть незаметно.

#### 2.2.2. Архитектура классов

##### Картинка, класс Image - все картинки в игре хранятся в глобальном массиве all_images, добавляются туда с помощью функции add_image(...)
* Уникальное наименование изображения
* Определяет свои размеры
* Определяет тип источника:
    * base64-строка
    * url
    * тайлсет
* Данные base64-строки, если надо
* url, если надо
* имя объекта тайлсета (из общего списка тайлсетов игры), если надо
* название картинки внутри тайлсета, если надо

##### Тайлсет (набор тайлов в виде картинки), класс TileSet - все тайлсеты лежат в глобальном массиве all_tilesets
* Уникальное имя тайлсета
* Имя объекта изображения, взятого за основу (из общего списка изображений игры)
* Список координат и имён картинок внутри тайлсета

##### Анимация, класс Animation - все анимации лежат в глобальном массиве animations
* Уникальное наименование анимации
* Количество кадров
* Базовая скорость (кадров в секунду), по умолчанию 2
* Список кадров

##### Базовая сущность рисования, класс Drawer:
* Определяет тип рисования чего-либо:
    * Просто цвет
    * Картинка (текстура)
    * Анимация
* Цвет (если рисование просто цветом)
* Имя объекта Image из списка изображений (если рисование изображением)
* Анимация, если тип рисования - анимация
* Прозрачность 
* Угол поворота

##### Класс тайла карты MapTile:
* проходим ли этот тайл
* если проходим то с какой скоростью (например если это болото - то медленнее)
* можно ли с ним взаимодействовать (например, это дверь)
* пропускает ли он свет (можно ли смотреть сквозь него, если можно - то глядя через него можно развеевать туман войны за ним)
* объект класса Drawer, определяющий как рисовать этот тайл
* функция вызываемая при взаимодействии
* кастомные свойства (js-объект)

##### Наследуемые классы тайлов карты:

Например:

* FogTile - ячейка "тумана" - по умолчанию чёрная ячейка, которая отрисовывается там где ячейки невидимы глазу игрока
* DungeonWallTile - ячейка стены лабиринта
* DungeonFloorTile - ячейка пола лабиринта
* DungeonWoodDoorTile - ячейка деревянной двери лабиринта
* TownWallTile - ячейка городской стены
* TownWoodBuildingTile - ячейка деревянной стены городского дома
* TownGrassTile - ячейка травы в городе
* TownRoadTile - ячейка дороги в городе

Каждая из этих ячеек отличается свойствами, способом отрисовки и т.д.

##### Базовый объект карты, класс Entity:
* Уникальный id
* Имя/тип сущности
* Позиция (x, y), скорость (vx, vy), угол поворота
* Радиус/габариты для коллизий (по умолчанию круг)
* Флаг проходимости сквозь стены (по умолчанию false, для призраков true)
* Флаг проходимости сквозь другие сущности (по умолчанию false)
* Набор Drawer-ов для отрисовки (map/dict по ключам состояний), плюс активный Drawer
* Ссылка на карту/мир
* Общие методы: update(dt), render(ctx), onInteract(actor), onRemove()

##### Движимая сущность, класс Actor (наследуется от Entity):
* Статы: hp, hpMax, скорость перемещения, урон, радиус агро и т.д.
* Состояние (idle, move, attack, dead и т.д.)
* Логика движения с учётом коллизий со стенами
* Базовые методы: move(dir, dt), takeDamage(amount), die()

##### Игрок, класс Player (наследуется от Actor):
* Управление с клавиатуры/мыши
* Вектор взгляда и направление атаки
* Инвентарь
* Методы взаимодействия с объектами (открыть, поднять, использовать)
* Набор Drawer-ов по состояниям/анимациям: стояние, ходьба, ближняя атака, дальняя атака, магия, получение урона, смерть

##### NPC, класс NPC (наследуется от Actor):
* Базовый ИИ: патруль/стоит на месте
* Диалоги/квесты (ссылка на сценарий)
* Возможность взаимодействия с игроком
* Набор Drawer-ов по состояниям, активный выбирается по логике ИИ

##### Враг, класс Enemy (наследуется от Actor):
* ИИ преследования/атаки
* Таблица дропа (что выпадет при смерти)
* Логика реакции на урон/агро
* Набор Drawer-ов по состояниям (idle/движение/атака/получение урона/смерть)

##### Предмет на земле, класс GroundItem (наследуется от Entity):
* Ссылка на предмет (itemId)
* Количество
* Возможность поднять
* Drawer (обычно один), но может быть анимация (например, свечение)

##### Сундук/контейнер, класс Chest (наследуется от Entity):
* Список лута
* Состояние открыто/закрыто
* Логика открытия (возможны ключи/условия)
* Drawer-ы для состояний «закрыт/открыт/ломается»

##### Прочие объекты:
* Projectile (стрелы, снаряды) — особый Entity с временем жизни и попаданиями
* Trigger/Zone — невидимые объекты, срабатывающие при входе

##### Класс карты Map

* Имеет размеры width, height
* Имеет число seed, отвечающее за случайную генерацию всего что создаётся случайно на карте
* Имеет 2Д и 1Д массивы всех тайлов
* Имеет массив всех "объектов" игры (наследников Entity)
* Имеет массивы "объектов" игры по округлённым координатам x,y, то есть, например, parseInt(x / 100), parseInt(y/ 100) и таким образом, при отрисовке огромной карты можно учитывать только недалеко находящиеся объекты, а остальные игнорировать

##### Класс игры

* Имеет ссылку на пользователя (хотя мог бы найти его на карте - но так быстрее)
* Имеет ссылку на карту
* Изначально рисует все тайлы карты, попадающие в экран.
    * Вместо невидимых тайлов рисует тайлы "тумана"
* Затем рисует все объекты (Entiry), сначала выбирая их по округлённым координатам, затем по тому, находятся ли они на экране или нет, если они "в тумане" - не рисует, иначе - рисует с помощью объектов Drawer которые на них сейчас активны
* Затем рисует элементы HUD - количество здоровья игрока, его активный инвентарь, текущее оружие и т.д.



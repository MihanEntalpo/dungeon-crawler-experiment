# Workflow

### Добавить README.md с описанием прототипа

#### Возникшие сложности, и способы их устранения

* Нужно было понять функциональность прототипа.

#### Принятые решения

* Изучен `index.html` с полным кодом прототипа.
* Создан `README.md` с описанием возможностей и запуска.

### Разделить single-file на HTML/CSS/JS и разнести по папкам

#### Возникшие сложности, и способы их устранения

* Нужно было аккуратно вынести стили и скрипт без потери функциональности.

#### Принятые решения

* Вынесены стили в `css/style.css`, скрипт в `js/game.js`.
* Обновлён `index.html`, добавлены папки `css/` и `js/`.

### Вынести утилиты и константы в отдельные файлы

#### Возникшие сложности, и способы их устранения

* Следить, чтобы константы и утилиты подключались до основного кода.

#### Принятые решения

* Добавлены `js/tools.js` и `js/consts.js` с JSDoc.
* Обновлён порядок подключений в `index.html`.

### Создать каркасы классов по plan.md

#### Возникшие сложности, и способы их устранения

* Требовалось соблюсти порядок зависимостей.

#### Принятые решения

* Созданы файлы классов в `js/classes/` и подключены в нужной последовательности.

### Разнести логику по классам и собрать архитектуру

#### Возникшие сложности, и способы их устранения

* Перенос функций из `game.js` в классы без регрессий.

#### Принятые решения

* Добавлены классы `Game`, `World`, `EntityManager`, `GameMap`, `FogOfWar`, `Camera`, `InputManager`, `Collision` и др.
* `js/game.js` оставлен как точка входа.

### Добавить глобальные словари ресурсов

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен `js/globals.js` с `all_images`, `all_tilesets`, `animations`.

### Перевести рендер на Drawer

#### Возникшие сложности, и способы их устранения

* Нужно было заменить прямой рендер сущностей на Drawer.

#### Принятые решения

* `Drawer` принимает кастомный render.
* `EntityManager` рендерит через активный Drawer.

### Вынести HUD в отдельный слой

#### Возникшие сложности, и способы их устранения

* HUD не должен зависеть от тумана войны.

#### Принятые решения

* Добавлен класс `HUD`.
* HUD рисуется поверх тумана войны.

### Настроить деплой на GitHub Pages

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен workflow `.github/workflows/gh-pages.yml`.

### Добавить сохранение карты и сущностей через localForage

#### Возникшие сложности, и способы их устранения

* Нужно было обеспечить автосохранение и корректную загрузку.

#### Принятые решения

* Карта сохраняется в `map_v1`, сущности — в `entities_v1`.
* Автосохранение каждые 5 секунд.

### Реализовать главное меню

#### Возникшие сложности, и способы их устранения

* Загрузка доступна только при наличии сохранения.

#### Принятые решения

* Добавлен HTML-UI с кнопками «Новая игра»/«Загрузить».
* «Загрузить» отключается, если сохранения нет.

### Добавить паузу при потере фокуса и по Esc

#### Возникшие сложности, и способы их устранения

* Нужно корректно останавливать игровой цикл.

#### Принятые решения

* Добавлен оверлей паузы и кнопка «Продолжить».
* Пауза по `blur`, `visibilitychange`, `fullscreenchange` и `Esc`.

### Реализовать мобильное управление

#### Возникшие сложности, и способы их устранения

* Нужно поддержать два джойстика и fullscreen.

#### Принятые решения

* Добавлены touch-джойстики и атака правым стиком.
* На мобильных запуск и продолжение переводит в fullscreen.

### Исправить камеру и боёвку

#### Возникшие сложности, и способы их устранения

* На телефоне камера была смещена; атака проходила сквозь стены.

#### Принятые решения

* Камера центрируется при resize и в mobile при неактивном look.
* Добавлен LOS‑чек для атаки.
* Добавлены дуги атаки врагов.

### Исправить смещение камеры при атаке на мобильных

#### Возникшие сложности, и способы их устранения

* Камера смещалась влево‑вверх при активации правого стика на вертикальном экране.

#### Принятые решения

* Для touch‑режима камера теперь целится на точку на 1/3 ширины экрана впереди игрока по направлению атаки.

### Обновить README.md и plan.md с актуальными знаниями о проекте

#### Возникшие сложности, и способы их устранения

* Нужно синхронизировать документацию с текущим состоянием архитектуры и фич.

#### Принятые решения

* README расширен описанием меню, сохранений, паузы и мобильного режима.
* plan.md дополнен сведениями о глобальных словарях, Drawer‑рендере, HUD и mobile‑input.

### Добавить debug-classes.html и debug-classes.js для статического рендера

#### Возникшие сложности, и способы их устранения

* Нужно изолировать отладочный стенд от основной игры и сохранить порядок подключений.

#### Принятые решения

* Создан `debug-classes.html` с подключением всех классов и скриптов.
* Добавлен `js/debug-classes.js` для статического рендера небольшой карты.

### Добавить статический рендер игрока и врагов в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужен рендер сущностей без игрового цикла и управления.

#### Принятые решения

* В `js/debug-classes.js` создан Player и несколько Enemy, рендер через EntityManager.

### Добавить debug-панель с seed и перегенерацией в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужен детерминированный сид и сохранение между перезапусками.

#### Принятые решения

* Добавлен toolbar в `debug-classes.html` с полем seed и кнопкой «Перегенерировать».
* В `js/debug-classes.js` реализован seeded‑генератор и сохранение seed в localForage.

### Добавить переключатель «Вращение» в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно анимировать поворот без игрового цикла и управления.

#### Принятые решения

* Добавлена галочка «Вращение» в toolbar.
* В `js/debug-classes.js` добавлен loop с плавным изменением facing у игрока и врагов.

### Добавить PolyHedronDrawer для отрисовки многогранников

#### Возникшие сложности, и способы их устранения

* Для сложных многогранников нужен минимум заглушек без точной геометрии.

#### Принятые решения

* Реализован `js/classes/polyhedron-drawer.js` с базовыми полигонами и освещением.
* Для сложных типов добавлены placeholder‑рисунки.

### Добавить валидацию имени в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно исключить некорректные имена типов.

#### Принятые решения

* Добавлен список допустимых имён и проверка в конструкторе.

### Добавить отрисовку PolyHedronDrawer в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно разместить много типов по сетке и синхронизировать с режимом вращения.

#### Принятые решения

* В `js/debug-classes.js` добавлен рендер всех типов многогранников с рандомным цветом.
* Режим «Вращение» влияет и на их поворот.

### Перевести PolyHedronDrawer на 3D‑отрисовку с освещением

#### Возникшие сложности, и способы их устранения

* Не для всех многогранников есть явные координатные модели.

#### Принятые решения

* Для базовых форм используются 3D‑меши с освещением по нормалям.
* Для сложных форм — 3D‑заглушка на основе пирамиды.

### Исправить чёрный цвет у PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Поддержка hsl()/rgb() не учитывалась при подсветке граней.

#### Принятые решения

* Добавлен парсер цветов и конвертация hsl→rgb перед расчётом оттенков.

### Улучшить цветность граней PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Освещение делало грани слишком серыми и убивало базовый цвет.

#### Принятые решения

* Скорректирована формула яркости, чтобы сохранялся цвет при освещении.

### Добавить поддержку эйлеровых углов в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно комбинировать повороты по трём осям в 3D‑рендере.

#### Принятые решения

* Добавлены поля `euler` и вращение по X/Y/Z в PolyHedronDrawer.
* В debug‑рендере связали вращение с тремя осями.

### Добавить панель углов Эйлера для всех многогранников

#### Возникшие сложности, и способы их устранения

* Нужна массовая настройка углов без ручной разметки HTML.

#### Принятые решения

* Панель создаётся динамически в `js/debug-classes.js` на основе списка типов.
* Введённые углы применяются в радианах, вращение учитывает их как базу.

### Сохранить углы Эйлера в debug‑панели

#### Возникшие сложности, и способы их устранения

* Нужно хранить пользовательские углы между перезагрузками.

#### Принятые решения

* Углы сохраняются в localForage по ключу `debug_poly_euler`.

### Исправить пропадающие грани у додекаэдра

#### Возникшие сложности, и способы их устранения

* Часть граней имела обратный порядок вершин, нормали смотрели вниз.

#### Принятые решения

* Добавлена автокоррекция направления нормали через центроид грани.

### Исправить пропадающие грани у кубоктаэдра

#### Возникшие сложности, и способы их устранения

* Часть граней имела нормаль почти перпендикулярную оси Z и отбрасывалась.

#### Принятые решения

* Ослаблен фильтр по normal.z: теперь рисуются обе стороны, если нормаль не нулевая.

### Заменить модель додекаэдра на точные координаты граней

#### Возникшие сложности, и способы их устранения

* Требовалось правильно сопоставить вершины и грани из внешнего описания.

#### Принятые решения

* Добавлен helper `meshFromFaces` и применён к додекаэдру с заданными координатами.

### Исправить синтаксис после замены мешей

#### Возникшие сложности, и способы их устранения

* После частичной замены оставались фрагменты старых мешей, ломавшие парсинг.

#### Принятые решения

* Очищены остатки старых блоков и восстановлены корректные меши.

### Вынести меши многогранников в отдельный файл meshes.js

#### Возникшие сложности, и способы их устранения

* Нужно сохранить порядок подключений скриптов.

#### Принятые решения

* Создан `js/meshes.js`, данные мешей перенесены туда.
* `polyhedron-drawer.js` использует `POLY_MESHES`.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить единый масштаб остальных фигур.

#### Принятые решения

* Радиус сферы уменьшен на 20% относительно базового.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить единый масштаб остальных фигур.

#### Принятые решения

* Радиус сферы уменьшен на 20% относительно базового.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить корректный масштаб остальных фигур.

#### Принятые решения

* (выполнится далее) снижу радиус сферы на 20% относительно базового.

### Вынести меши многогранников в отдельный файл meshes.js

### Обновить координаты кубоктаэдра по заданным данным

#### Возникшие сложности, и способы их устранения

* Нужно было заменить только модель кубоктаэдра без поломки остальных мешей.

#### Принятые решения

* В `js/meshes.js` кубоктаэдр переведён на меш из переданных граней.

### Добавить заглушки мешей для всех оставшихся многогранников

#### Возникшие сложности, и способы их устранения

* Нужно было унифицировать временные меши и убрать вычисление “на коленке” из рантайма.

#### Принятые решения

* В `js/meshes.js` добавлены placeholder‑меши для всех недостающих типов из PolyHedronDrawer.

### Зафиксировать использование мешей только из POLY_MESHES

#### Возникшие сложности, и способы их устранения

* Нужно исключить генерацию мешей на лету и оставить только данные из `js/meshes.js`.

#### Принятые решения

* В `PolyHedronDrawer.getMesh` оставлен выбор только из `POLY_MESHES`, с fallback на cube.

### Добавить default_euler во все меши POLY_MESHES

#### Возникшие сложности, и способы их устранения

* Нужно было унифицировать поле базовых углов для всех мешей.

#### Принятые решения

* В `js/meshes.js` добавлен `default_euler` (0,0,0) для всех мешей, включая helper‑меши.

### Добавить textarea с экспортом углов Эйлера в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно синхронизировать вывод с изменениями инпутов и регенерацией.

#### Принятые решения

* В `debug-classes.html` добавлен textarea, в `js/debug-classes.js` — функция вывода формата `name: x, y, z`.

### Заменить меш truncated_hexahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `truncated_hexahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш truncated_octahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `truncated_octahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш small_rhombicuboctahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `small_rhombicuboctahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш great_rhombicuboctahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `great_rhombicuboctahedron` теперь строится из переданных граней через `meshFromFaces`.

### Исправить пропадающие грани у great_rhombicuboctahedron

#### Возникшие сложности, и способы их устранения

* Часть граней имела нормаль почти параллельную Z, и они отсеивались фильтром.

#### Принятые решения

* В `PolyHedronDrawer.renderMesh` убран фильтр по `normal.z`, чтобы рисовать все грани.

### Проверить меш "truncated cuboctahedron" (great_rhombicuboctahedron)

#### Возникшие сложности, и способы их устранения

* В сообщении было несоответствие названия и типа, нужно было сверить фактические данные.

#### Принятые решения

* Сравнил данные: меш `great_rhombicuboctahedron` уже совпадает с присланными гранями, изменений не требуется.

### Заменить меш great_rhombicuboctahedron на новый набор граней

#### Возникшие сложности, и способы их устранения

* Нужно было полностью заменить список граней, чтобы избежать пропусков.

#### Принятые решения

* В `js/meshes.js` `great_rhombicuboctahedron` заменён на присланный массив граней.

### Заменить меш snub_hexahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести большой список граней без опечаток.

#### Принятые решения

* В `js/meshes.js` `snub_hexahedron` заменён на присланный массив граней через `meshFromFaces`.

### Разбить изменения на логические коммиты

#### Возникшие сложности, и способы их устранения

* Git не был настроен (user.name/user.email отсутствовали), коммит не проходил.

#### Принятые решения

* Настроены локальные git-параметры `user.name` и `user.email` для репозитория.

# Workflow

### Добавить README.md с описанием прототипа

#### Возникшие сложности, и способы их устранения

* Нужно было понять функциональность прототипа.

#### Принятые решения

* Изучен `index.html` с полным кодом прототипа.
* Создан `README.md` с описанием возможностей и запуска.

### Разделить single-file на HTML/CSS/JS и разнести по папкам

#### Возникшие сложности, и способы их устранения

* Нужно было аккуратно вынести стили и скрипт без потери функциональности.

#### Принятые решения

* Вынесены стили в `css/style.css`, скрипт в `js/game.js`.
* Обновлён `index.html`, добавлены папки `css/` и `js/`.

### Вынести утилиты и константы в отдельные файлы

#### Возникшие сложности, и способы их устранения

* Следить, чтобы константы и утилиты подключались до основного кода.

#### Принятые решения

* Добавлены `js/tools.js` и `js/consts.js` с JSDoc.
* Обновлён порядок подключений в `index.html`.

### Создать каркасы классов по plan.md

#### Возникшие сложности, и способы их устранения

* Требовалось соблюсти порядок зависимостей.

#### Принятые решения

* Созданы файлы классов в `js/classes/` и подключены в нужной последовательности.

### Разнести логику по классам и собрать архитектуру

#### Возникшие сложности, и способы их устранения

* Перенос функций из `game.js` в классы без регрессий.

#### Принятые решения

* Добавлены классы `Game`, `World`, `EntityManager`, `GameMap`, `FogOfWar`, `Camera`, `InputManager`, `Collision` и др.
* `js/game.js` оставлен как точка входа.

### Добавить глобальные словари ресурсов

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен `js/globals.js` с `all_images`, `all_tilesets`, `animations`.

### Перевести рендер на Drawer

#### Возникшие сложности, и способы их устранения

* Нужно было заменить прямой рендер сущностей на Drawer.

#### Принятые решения

* `Drawer` принимает кастомный render.
* `EntityManager` рендерит через активный Drawer.

### Вынести HUD в отдельный слой

#### Возникшие сложности, и способы их устранения

* HUD не должен зависеть от тумана войны.

#### Принятые решения

* Добавлен класс `HUD`.
* HUD рисуется поверх тумана войны.

### Настроить деплой на GitHub Pages

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен workflow `.github/workflows/gh-pages.yml`.

### Добавить сохранение карты и сущностей через localForage

#### Возникшие сложности, и способы их устранения

* Нужно было обеспечить автосохранение и корректную загрузку.

#### Принятые решения

* Карта сохраняется в `map_v1`, сущности — в `entities_v1`.
* Автосохранение каждые 5 секунд.

### Реализовать главное меню

#### Возникшие сложности, и способы их устранения

* Загрузка доступна только при наличии сохранения.

#### Принятые решения

* Добавлен HTML-UI с кнопками «Новая игра»/«Загрузить».
* «Загрузить» отключается, если сохранения нет.

### Добавить паузу при потере фокуса и по Esc

#### Возникшие сложности, и способы их устранения

* Нужно корректно останавливать игровой цикл.

#### Принятые решения

* Добавлен оверлей паузы и кнопка «Продолжить».
* Пауза по `blur`, `visibilitychange`, `fullscreenchange` и `Esc`.

### Реализовать мобильное управление

#### Возникшие сложности, и способы их устранения

* Нужно поддержать два джойстика и fullscreen.

#### Принятые решения

* Добавлены touch-джойстики и атака правым стиком.
* На мобильных запуск и продолжение переводит в fullscreen.

### Исправить камеру и боёвку

#### Возникшие сложности, и способы их устранения

* На телефоне камера была смещена; атака проходила сквозь стены.

#### Принятые решения

* Камера центрируется при resize и в mobile при неактивном look.
* Добавлен LOS‑чек для атаки.
* Добавлены дуги атаки врагов.

### Исправить смещение камеры при атаке на мобильных

#### Возникшие сложности, и способы их устранения

* Камера смещалась влево‑вверх при активации правого стика на вертикальном экране.

#### Принятые решения

* Для touch‑режима камера теперь целится на точку на 1/3 ширины экрана впереди игрока по направлению атаки.

### Обновить README.md и plan.md с актуальными знаниями о проекте

#### Возникшие сложности, и способы их устранения

* Нужно синхронизировать документацию с текущим состоянием архитектуры и фич.

#### Принятые решения

* README расширен описанием меню, сохранений, паузы и мобильного режима.
* plan.md дополнен сведениями о глобальных словарях, Drawer‑рендере, HUD и mobile‑input.

### Добавить debug-classes.html и debug-classes.js для статического рендера

#### Возникшие сложности, и способы их устранения

* Нужно изолировать отладочный стенд от основной игры и сохранить порядок подключений.

#### Принятые решения

* Создан `debug-classes.html` с подключением всех классов и скриптов.
* Добавлен `js/debug-classes.js` для статического рендера небольшой карты.

### Добавить статический рендер игрока и врагов в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужен рендер сущностей без игрового цикла и управления.

#### Принятые решения

* В `js/debug-classes.js` создан Player и несколько Enemy, рендер через EntityManager.

### Добавить debug-панель с seed и перегенерацией в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужен детерминированный сид и сохранение между перезапусками.

#### Принятые решения

* Добавлен toolbar в `debug-classes.html` с полем seed и кнопкой «Перегенерировать».
* В `js/debug-classes.js` реализован seeded‑генератор и сохранение seed в localForage.

### Добавить переключатель «Вращение» в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно анимировать поворот без игрового цикла и управления.

#### Принятые решения

* Добавлена галочка «Вращение» в toolbar.
* В `js/debug-classes.js` добавлен loop с плавным изменением facing у игрока и врагов.

### Добавить PolyHedronDrawer для отрисовки многогранников

#### Возникшие сложности, и способы их устранения

* Для сложных многогранников нужен минимум заглушек без точной геометрии.

#### Принятые решения

* Реализован `js/classes/polyhedron-drawer.js` с базовыми полигонами и освещением.
* Для сложных типов добавлены placeholder‑рисунки.

### Добавить валидацию имени в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно исключить некорректные имена типов.

#### Принятые решения

* Добавлен список допустимых имён и проверка в конструкторе.

### Добавить отрисовку PolyHedronDrawer в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно разместить много типов по сетке и синхронизировать с режимом вращения.

#### Принятые решения

* В `js/debug-classes.js` добавлен рендер всех типов многогранников с рандомным цветом.
* Режим «Вращение» влияет и на их поворот.

### Перевести PolyHedronDrawer на 3D‑отрисовку с освещением

#### Возникшие сложности, и способы их устранения

* Не для всех многогранников есть явные координатные модели.

#### Принятые решения

* Для базовых форм используются 3D‑меши с освещением по нормалям.
* Для сложных форм — 3D‑заглушка на основе пирамиды.

### Исправить чёрный цвет у PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Поддержка hsl()/rgb() не учитывалась при подсветке граней.

#### Принятые решения

* Добавлен парсер цветов и конвертация hsl→rgb перед расчётом оттенков.

### Улучшить цветность граней PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Освещение делало грани слишком серыми и убивало базовый цвет.

#### Принятые решения

* Скорректирована формула яркости, чтобы сохранялся цвет при освещении.

### Добавить поддержку эйлеровых углов в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно комбинировать повороты по трём осям в 3D‑рендере.

#### Принятые решения

* Добавлены поля `euler` и вращение по X/Y/Z в PolyHedronDrawer.
* В debug‑рендере связали вращение с тремя осями.

### Добавить панель углов Эйлера для всех многогранников

#### Возникшие сложности, и способы их устранения

* Нужна массовая настройка углов без ручной разметки HTML.

#### Принятые решения

* Панель создаётся динамически в `js/debug-classes.js` на основе списка типов.
* Введённые углы применяются в радианах, вращение учитывает их как базу.

### Сохранить углы Эйлера в debug‑панели

#### Возникшие сложности, и способы их устранения

* Нужно хранить пользовательские углы между перезагрузками.

#### Принятые решения

* Углы сохраняются в localForage по ключу `debug_poly_euler`.

### Исправить пропадающие грани у додекаэдра

#### Возникшие сложности, и способы их устранения

* Часть граней имела обратный порядок вершин, нормали смотрели вниз.

#### Принятые решения

* Добавлена автокоррекция направления нормали через центроид грани.

### Исправить пропадающие грани у кубоктаэдра

#### Возникшие сложности, и способы их устранения

* Часть граней имела нормаль почти перпендикулярную оси Z и отбрасывалась.

#### Принятые решения

* Ослаблен фильтр по normal.z: теперь рисуются обе стороны, если нормаль не нулевая.

### Заменить модель додекаэдра на точные координаты граней

#### Возникшие сложности, и способы их устранения

* Требовалось правильно сопоставить вершины и грани из внешнего описания.

#### Принятые решения

* Добавлен helper `meshFromFaces` и применён к додекаэдру с заданными координатами.

### Исправить синтаксис после замены мешей

#### Возникшие сложности, и способы их устранения

* После частичной замены оставались фрагменты старых мешей, ломавшие парсинг.

#### Принятые решения

* Очищены остатки старых блоков и восстановлены корректные меши.

### Вынести меши многогранников в отдельный файл meshes.js

#### Возникшие сложности, и способы их устранения

* Нужно сохранить порядок подключений скриптов.

#### Принятые решения

* Создан `js/meshes.js`, данные мешей перенесены туда.
* `polyhedron-drawer.js` использует `POLY_MESHES`.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить единый масштаб остальных фигур.

#### Принятые решения

* Радиус сферы уменьшен на 20% относительно базового.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить единый масштаб остальных фигур.

#### Принятые решения

* Радиус сферы уменьшен на 20% относительно базового.

### Уменьшить размер сферы в PolyHedronDrawer

#### Возникшие сложности, и способы их устранения

* Нужно сохранить корректный масштаб остальных фигур.

#### Принятые решения

* (выполнится далее) снижу радиус сферы на 20% относительно базового.

### Вынести меши многогранников в отдельный файл meshes.js

### Обновить координаты кубоктаэдра по заданным данным

#### Возникшие сложности, и способы их устранения

* Нужно было заменить только модель кубоктаэдра без поломки остальных мешей.

#### Принятые решения

* В `js/meshes.js` кубоктаэдр переведён на меш из переданных граней.

### Добавить заглушки мешей для всех оставшихся многогранников

#### Возникшие сложности, и способы их устранения

* Нужно было унифицировать временные меши и убрать вычисление “на коленке” из рантайма.

#### Принятые решения

* В `js/meshes.js` добавлены placeholder‑меши для всех недостающих типов из PolyHedronDrawer.

### Зафиксировать использование мешей только из POLY_MESHES

#### Возникшие сложности, и способы их устранения

* Нужно исключить генерацию мешей на лету и оставить только данные из `js/meshes.js`.

#### Принятые решения

* В `PolyHedronDrawer.getMesh` оставлен выбор только из `POLY_MESHES`, с fallback на cube.

### Добавить default_euler во все меши POLY_MESHES

#### Возникшие сложности, и способы их устранения

* Нужно было унифицировать поле базовых углов для всех мешей.

#### Принятые решения

* В `js/meshes.js` добавлен `default_euler` (0,0,0) для всех мешей, включая helper‑меши.

### Добавить textarea с экспортом углов Эйлера в debug-classes

#### Возникшие сложности, и способы их устранения

* Нужно синхронизировать вывод с изменениями инпутов и регенерацией.

#### Принятые решения

* В `debug-classes.html` добавлен textarea, в `js/debug-classes.js` — функция вывода формата `name: x, y, z`.

### Заменить меш truncated_hexahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `truncated_hexahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш truncated_octahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `truncated_octahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш small_rhombicuboctahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `small_rhombicuboctahedron` теперь строится из переданных граней через `meshFromFaces`.

### Заменить меш great_rhombicuboctahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести данные граней без потери порядка вершин.

#### Принятые решения

* В `js/meshes.js` `great_rhombicuboctahedron` теперь строится из переданных граней через `meshFromFaces`.

### Исправить пропадающие грани у great_rhombicuboctahedron

#### Возникшие сложности, и способы их устранения

* Часть граней имела нормаль почти параллельную Z, и они отсеивались фильтром.

#### Принятые решения

* В `PolyHedronDrawer.renderMesh` убран фильтр по `normal.z`, чтобы рисовать все грани.

### Проверить меш "truncated cuboctahedron" (great_rhombicuboctahedron)

#### Возникшие сложности, и способы их устранения

* В сообщении было несоответствие названия и типа, нужно было сверить фактические данные.

#### Принятые решения

* Сравнил данные: меш `great_rhombicuboctahedron` уже совпадает с присланными гранями, изменений не требуется.

### Заменить меш great_rhombicuboctahedron на новый набор граней

#### Возникшие сложности, и способы их устранения

* Нужно было полностью заменить список граней, чтобы избежать пропусков.

#### Принятые решения

* В `js/meshes.js` `great_rhombicuboctahedron` заменён на присланный массив граней.

### Заменить меш snub_hexahedron на заданные координаты

#### Возникшие сложности, и способы их устранения

* Нужно было перенести большой список граней без опечаток.

#### Принятые решения

* В `js/meshes.js` `snub_hexahedron` заменён на присланный массив граней через `meshFromFaces`.

### Разбить изменения на логические коммиты

#### Возникшие сложности, и способы их устранения

* Git не был настроен (user.name/user.email отсутствовали), коммит не проходил.

#### Принятые решения

* Настроены локальные git-параметры `user.name` и `user.email` для репозитория.

### Исправить меш snub_hexahedron на основе внешней 3D‑модели

#### Возникшие сложности, и способы их устранения

* Текущие координаты меша были повреждены, часть вершин не относилась к `snub_hexahedron`.
* Нужен был стабильный внешний источник с готовыми вершинами и гранями.

#### Принятые решения

* Использован файл `snub_cube.obj` из официального набора Inkscape (`Poly3DObjects`) из архива `inkscape_1.0.2.orig.tar.xz` (Debian).
* В `js/meshes.js` блок `snub_hexahedron` заменён на `verts/faces`, извлечённые из OBJ (24 вершины, 38 граней).

### Разбить meshes.js на отдельные файлы многогранников

#### Возникшие сложности, и способы их устранения

* Нужно было сохранить прежнее поведение загрузки без модульного сборщика.
* Важно не потерять ни один тип из `POLY_MESHES` при разнесении данных по файлам.

#### Принятые решения

* `js/meshes.js` оставлен как реестр и функция `registerPolyMesh(...)`.
* Все меши вынесены в `js/meshes/polyhedra/*.js` по одному многограннику на файл.
* Подключение всех mesh-файлов добавлено в `index.html` и `debug-classes.html` сразу после `js/meshes.js`.

### Обновить проблемные меши многогранников из внешних 3D‑источников

#### Возникшие сложности, и способы их устранения

* `small_rhombicuboctahedron` был близок к корректному, но содержал ошибочные вершины.
* Часть многогранников (`truncated_icosahedron`, `great_rhombicosidodecahedron`, `snub_dodecahedron`, `small_stellated_dodecahedron`, `great_stellated_dodecahedron`) использовали placeholder‑геометрию.
* Для `small_stellated_dodecahedron` не нашлось готового OBJ в наборе Inkscape.

#### Принятые решения

* Для `small_rhombicuboctahedron`, `icosidodecahedron`, `truncated_icosahedron`, `great_rhombicosidodecahedron`, `snub_dodecahedron`, `great_stellated_dodecahedron` использованы исходные OBJ‑файлы из `Inkscape/Poly3DObjects` (Debian архив `inkscape_1.0.2.orig.tar.xz`).
* Для `small_stellated_dodecahedron` использован VRML‑файл `u39.wrl` (bulatov.org), данные вершин и граней перенесены в формат проекта.
* Обновлены соответствующие файлы в `js/meshes/polyhedra/*.js`, добавлены source‑комментарии в каждом файле.

### Исправить рендер small_stellated_dodecahedron через разбиение пересечений на треугольники

#### Возникшие сложности, и способы их устранения

* У `small_stellated_dodecahedron` звёздчатые грани визуально проходили друг сквозь друга при текущем порядке отрисовки.
* Нужна была геометрия, где поверхности уже разрезаны на независимые треугольные фрагменты в точках пересечения.

#### Принятые решения

* Взята модель `Small stellated dodecahedron (fixed pentagrams).stl` (Wikimedia, CC0), где поверхность уже триангулирована с учётом пересечений.
* `js/meshes/polyhedra/small_stellated_dodecahedron.js` заменён на новый меш из STL (42 вершины, 96 треугольников).

### Добавить в debug-classes второй ряд многогранников 64x64

#### Возникшие сложности, и способы их устранения

* Нужно было отрисовать те же многогранники в другом масштабе, не ломая существующий ряд 32x32.
* Требовалось синхронизировать вращение и углы Эйлера между рядами, чтобы сравнение было корректным.

#### Принятые решения

* В `PolyHedronDrawer.render` добавлен опциональный `ent.renderSize` (если не задан, используется `TILE` как раньше).
* В `js/debug-classes.js` добавлен второй набор `polyhedronsLarge` (64x64), размещённый ниже с шагом 2 тайла (64 px) между центрами.
* Большой ряд синхронизируется с базовым рядом по повороту и Euler-углам.

### Убрать динамическое изменение масштаба многогранника при повороте

#### Возникшие сложности, и способы их устранения

* Масштаб фигуры пересчитывался от текущей проекции (`maxRadiusXY` после вращения), из-за чего при повороте менялся визуальный размер.

#### Принятые решения

* В `PolyHedronDrawer.renderMesh` масштаб переведён на фиксированный коэффициент из геометрии меша.
* Добавлен `getStableScaleRadius(mesh)` с кэшированием и расчётом через `maxRadiusXYZ` по исходным вершинам (без зависимости от текущего угла).

### Вернуть корректный рендер small_stellated_dodecahedron после правки масштаба

#### Возникшие сложности, и способы их устранения

* После изменения масштаба снова стали заметны артефакты на `small_stellated_dodecahedron`.
* Для звёздчатой геометрии автокоррекция нормалей через центроид и двусторонняя отрисовка давали визуальные конфликты.

#### Принятые решения

* В `PolyHedronDrawer.renderMesh` добавлены опции меша:
  * `skipAutoNormalFlip` — отключает автопереворот нормалей.
  * `cullBackfaces` — включает отсечение задних граней.
* Для `small_stellated_dodecahedron` включены `skipAutoNormalFlip: true` и `cullBackfaces: true`.
* Расчёт глубины грани переведён на среднее по всем вершинам грани (а не только по первым трём).

### Добавить режим полупрозрачной «памяти» тумана войны и скрытие врагов вне видимости

#### Возникшие сложности, и способы их устранения

* Нужно было сохранить переключаемость поведения через константы и не сломать текущий режим тумана.
* Требовалось скрывать только врагов в невидимых клетках, не затрагивая рендер игрока и остальных сущностей.

#### Принятые решения

* В `js/consts.js` добавлены константы `FOG_MEMORY_MODE_ENABLED`, `FOG_MEMORY_ALPHA`, `FOG_UNSEEN_ALPHA`, `FOG_HIDE_ENEMIES_OUTSIDE_VISIBLE`.
* В `js/classes/fog-of-war.js` отрисовка разделена на три состояния: видимо сейчас (без затемнения), неразведано (почти чёрное), разведано но не видно (полупрозрачное затемнение, если режим включён).
* В `js/classes/entity-manager.js` добавлен фильтр рендера врагов по текущей видимости клетки через `FogOfWar.isVisibleTile(...)`.
* В `js/classes/world.js` передача `world` в рендер сущностей для доступа к карте и туману войны.
* В `js/classes/game.js` при полном отключении тумана на выходе дополнительно заполняется `fog.visible`, чтобы снова показывать всех врагов.

### Добавить плавный fade при переходе тайла из visible в hidden

#### Возникшие сложности, и способы их устранения

* Нужно было добавить плавность только на переходе из видимого состояния в скрытое, не ломая мгновенное раскрытие клетки, когда она снова видна.
* Важно было сохранить управляемость режима через константы.

#### Принятые решения

* В `js/consts.js` добавлены константы `FOG_VISIBILITY_FADE_ENABLED` и `FOG_VISIBILITY_FADE_MS`.
* В `js/classes/fog-of-war.js` добавлен буфер `overlayAlpha` и метод `updateFade(dt)`: у видимых клеток альфа сразу 0, у скрытых — плавно растёт к целевой альфе.
* В `js/classes/game.js` вызов `fog.updateFade(dt)` добавлен в `update(...)` сразу после пересчёта видимости.
* При полном отключении тумана (`выход найден`) альфа-буфер очищается через `fog.overlayAlpha.fill(0)`.

### Настроить длительность fade тумана войны на 1 секунду

#### Возникшие сложности, и способы их устранения

* Нужно было изменить только параметр скорости эффекта, не затрагивая логику вычисления видимости.

#### Принятые решения

* В `js/consts.js` константа `FOG_VISIBILITY_FADE_MS` изменена на `1000` (1 секунда).
* Управление скоростью fade остаётся через эту константу.

### Добавить плавное исчезновение врагов в затемнённых клетках

#### Возникшие сложности, и способы их устранения

* Враги скрывались мгновенно по булевому условию видимости, поэтому нельзя было сделать визуальный fade.
* Нужно было сохранить правило, что в полностью скрытом состоянии враг не должен быть виден вообще.

#### Принятые решения

* В `js/classes/entity-manager.js` добавлен per-enemy буфер альфы `enemyFogAlpha` и расчёт `computeEnemyFogAlpha(...)`.
* Fade врагов обновляется в `updateFogVisibilityFade(dt, world, fogEnabled)` и использует `FOG_VISIBILITY_FADE_MS`.
* Рендер врагов теперь учитывает текущую альфу через `ctx.globalAlpha`, а при нуле враг не рисуется.
* В `js/classes/game.js` добавлен вызов `this.entities.updateFogVisibilityFade(dt, this.world, this.fogEnabled)` после пересчёта видимости.

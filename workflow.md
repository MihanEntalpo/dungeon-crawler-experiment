# Workflow

### Добавить README.md с описанием прототипа

#### Возникшие сложности, и способы их устранения

* Нужно было понять функциональность прототипа.

#### Принятые решения

* Изучен `index.html` с полным кодом прототипа.
* Создан `README.md` с описанием возможностей и запуска.

### Разделить single-file на HTML/CSS/JS и разнести по папкам

#### Возникшие сложности, и способы их устранения

* Нужно было аккуратно вынести стили и скрипт без потери функциональности.

#### Принятые решения

* Вынесены стили в `css/style.css`, скрипт в `js/game.js`.
* Обновлён `index.html`, добавлены папки `css/` и `js/`.

### Вынести утилиты и константы в отдельные файлы

#### Возникшие сложности, и способы их устранения

* Следить, чтобы константы и утилиты подключались до основного кода.

#### Принятые решения

* Добавлены `js/tools.js` и `js/consts.js` с JSDoc.
* Обновлён порядок подключений в `index.html`.

### Создать каркасы классов по plan.md

#### Возникшие сложности, и способы их устранения

* Требовалось соблюсти порядок зависимостей.

#### Принятые решения

* Созданы файлы классов в `js/classes/` и подключены в нужной последовательности.

### Разнести логику по классам и собрать архитектуру

#### Возникшие сложности, и способы их устранения

* Перенос функций из `game.js` в классы без регрессий.

#### Принятые решения

* Добавлены классы `Game`, `World`, `EntityManager`, `GameMap`, `FogOfWar`, `Camera`, `InputManager`, `Collision` и др.
* `js/game.js` оставлен как точка входа.

### Добавить глобальные словари ресурсов

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен `js/globals.js` с `all_images`, `all_tilesets`, `animations`.

### Перевести рендер на Drawer

#### Возникшие сложности, и способы их устранения

* Нужно было заменить прямой рендер сущностей на Drawer.

#### Принятые решения

* `Drawer` принимает кастомный render.
* `EntityManager` рендерит через активный Drawer.

### Вынести HUD в отдельный слой

#### Возникшие сложности, и способы их устранения

* HUD не должен зависеть от тумана войны.

#### Принятые решения

* Добавлен класс `HUD`.
* HUD рисуется поверх тумана войны.

### Настроить деплой на GitHub Pages

#### Возникшие сложности, и способы их устранения

* Нет.

#### Принятые решения

* Добавлен workflow `.github/workflows/gh-pages.yml`.

### Добавить сохранение карты и сущностей через localForage

#### Возникшие сложности, и способы их устранения

* Нужно было обеспечить автосохранение и корректную загрузку.

#### Принятые решения

* Карта сохраняется в `map_v1`, сущности — в `entities_v1`.
* Автосохранение каждые 5 секунд.

### Реализовать главное меню

#### Возникшие сложности, и способы их устранения

* Загрузка доступна только при наличии сохранения.

#### Принятые решения

* Добавлен HTML-UI с кнопками «Новая игра»/«Загрузить».
* «Загрузить» отключается, если сохранения нет.

### Добавить паузу при потере фокуса и по Esc

#### Возникшие сложности, и способы их устранения

* Нужно корректно останавливать игровой цикл.

#### Принятые решения

* Добавлен оверлей паузы и кнопка «Продолжить».
* Пауза по `blur`, `visibilitychange`, `fullscreenchange` и `Esc`.

### Реализовать мобильное управление

#### Возникшие сложности, и способы их устранения

* Нужно поддержать два джойстика и fullscreen.

#### Принятые решения

* Добавлены touch-джойстики и атака правым стиком.
* На мобильных запуск и продолжение переводит в fullscreen.

### Исправить камеру и боёвку

#### Возникшие сложности, и способы их устранения

* На телефоне камера была смещена; атака проходила сквозь стены.

#### Принятые решения

* Камера центрируется при resize и в mobile при неактивном look.
* Добавлен LOS‑чек для атаки.
* Добавлены дуги атаки врагов.

### Исправить смещение камеры при атаке на мобильных

#### Возникшие сложности, и способы их устранения

* Камера смещалась влево‑вверх при активации правого стика на вертикальном экране.

#### Принятые решения

* Для touch‑режима камера теперь целится на точку на 1/3 ширины экрана впереди игрока по направлению атаки.
